## 자바스크립트의 작동 원리

![자바스크립트 동작 원리](/public/images/javascript/how-javascript-works/자바스크립트_동작_원리.png)

자바스크립트는 싱글 스레드이며 동시에 논블로킹으로 작동한다. 논블로킹이란 어떤 코드의 실행이 다른 코드의 실행을 막지 않는다는 것을 의미한다. 이미지를 로드하면서도 버튼을 클릭할 수 있는 것이다. 이것은 곧 자바스크립트가 비동기적으로 작동한다는 것을 의미한다.

브라우저에서는 자바스크립트 파일을 해석해주는 자바스크립트 엔진이 존재하는데, 이 콜스택(Call Stack)에서는 먼저 들어간 것이 나중에 나오게 되고 맨 마지막에 들어간 것이 제일 먼저 처리 된다. 이곳에서 Call이 쌓이고 처리되면서 코드를 실행하는 것이다. 그럼 자바스크립트는 어떻게 이 하나의 콜스택에서 비동기적으로 코드를 실행하는걸까?

### 자바스크립트의 비동기 동작

자바스크립트는 비동기 처리에 Web API와 이벤트 루프(Event Loop), 큐(Queue)를 활용한다.

만약 콜스택에 콜이 쌓인대로 처리하고 있는데, 중간에 연산이 오래 걸리는 함수가 있다면 자바스크립트 엔진은 이 오래 걸리는 작업을 대기실에 옮긴다. 그리고 바로 다음 코드를 실행한다. 순서대로 실행되길 기다리지 않고 다음으로 바로 넘어가기 때문에 비동기적인 것이다.

그렇다면 옮겨진 오래 걸리는 함수는 다시 처리해야될 때가 되면 이벤트 루프에 의해 큐(Queue)에 추가되고 큐에서 순서대로 줄지어진다. 그리고 줄지어진 순서대로 하나씩 다시 콜스택에 들어가서 처리된다.

예시로 중간에 1초 후에 실행되어야 하는 `setTimeout` 함수가 있는 상황이라고 가정해보자.

```javascript
console.log('first');

setTimeout(() => {
  console.log('third');
}, 1000);

console.log('second');
```

> `setTimeout` 함수가 있는 자바스크립트 엔진 동작 순서
>
> 1. `console.log("first")` 가 콜스택에 추가, 실행되어 없어짐
>
>    - 콘솔에 first 가 찍힘
>
> 2. `setTimeout` 함수가 콜스택에 추가, 실행되어 없어짐
>
>    - 실행만 된 것이고 Web APIs에 타이머가 등록됨
>
> 3. 다음 `console.log("second")` 가 콜스택에 추가, 실행되어 없어짐
>
>    - 콘솔에 second 가 찍힘
>
> 4. 타이머의 시간이 다 지났다면 `setTimeout` 내 콜백함수가 큐에 들어오게 됨.
>
> 5. 이벤트 루프가 큐에 있는 콜백함수를 콜스택에 전달
>
> 6. 콜백함수 내에 있는 `console.log("third")` 함수를 실행.
>
>    - 이후 콜백함수 전체 다 실행됨.

처리할 작업이 없는 경우에 이벤트 루프는 대기 상태로 들어가서 전원을 아끼가거나 가비지 컬렉션 같은 관리 작업을 하기도 한다.이벤트 발생에는 마우스 클릭 외에도 키보드 입력이나 AJAX 등이 있다.

### 추가로 알 수 있는 비동기 호출 순서 제어 작동 원리

현재 ES6 문법에 의하면 `Promise`나 `async-await`로 비동기 함수를 동기적으로 제어할 수 있다. 그렇다면 자바스크립트는 비동기 호출 순서를 어떻게 동기적으로 제어할 수 있는 걸까?

이벤트 루프에 의해 콜스택에 콜백함수가 들어갈 때를 보면 알 수 있다. 함수의 내부가 먼저 실행되기 때문에 먼저 실행되어야 하는 작업이 있는 경우 함수 인자에 넣어 내부에서 먼저 동작하도록 만든다. 자바스크립트는 콜백함수를 이용하여 비동기 호출 순서를 제어하는 것이었다.

## 작동 원리를 본 후 주의해야할 점

1. 콜스택을 바쁘게 하지 말기

   주의해야할 점은 큐는 콜스택이 비었을 때만 작업을 보낸다는 것이다. 그래서 스택에 엄청나게 많은 작업이 있을 경우(ex.for문 1000번 등 어려운 계산) 큐에 있는 코드가 실행되지 못해 에러가 발생할 수 있다. 이벤트 리스너가 달려있는 버튼 클릭에 반응이 없거나 ajax 요청이 안되거나, `setTimeout` 타이머가 동작하지 않는다.

   따라서 성능이 나빠질 수 있으니 콜스택을 과도하게 바쁘게 만들지 않을 것!

&nbsp;

---

&nbsp;

출처

- [블로그:how-javascript-works-event-loop](https://medium.com/sessionstack-blog/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with-2f077c4438b5)

- [영상:Event loop와 call stack 은 어떻게 작동하나?](https://www.youtube.com/watch?v=zi-IG6VHBh8&t=133s)
