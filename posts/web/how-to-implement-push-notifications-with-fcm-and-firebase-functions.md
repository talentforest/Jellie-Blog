## ì›¹ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ê°œë°œí•˜ê²Œ ëœ ê³„ê¸°

ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ë…ì„œëª¨ì„ í•œí˜ì´ì§€ ê¸°ë¡ì•±ì„ PWAë¡œ ë§Œë“¤ì—ˆë‹¤ê³  ì´ì•¼ê¸°í–ˆëŠ”ë°, PWAë¡œ ë§Œë“  ì´ìœ ëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ êµ¬í˜„í•´ë³´ê³  ì‹¶ì—ˆê¸° ë•Œë¬¸ì´ë‹¤. ì´ì „ì—ëŠ” **ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•˜ê¸°** ê¸°ëŠ¥ì„ ì œê³µí•´ì„œ ë…ì„œëª¨ì„ ë©¤ë²„ê°€ ë°œì œë¬¸ì´ë‚˜ ì •ë¦¬ ê¸°ë¡ ê°™ì€ ê¸€ì„ ë“±ë¡í•˜ë©´ ì§ì ‘ ê³µìœ í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ê¸€ì„ ë“±ë¡í•œ ê²ƒì„ ì•Œ ìˆ˜ ìˆë„ë¡ í–ˆë‹¤. ê·¸ëŸ°ë° ì‹œê°„ì´ ì§€ë‚˜ë‹¤ ë³´ë‹ˆ ë©¤ë²„ë“¤ì´ ê¸€ì„ ì˜¬ë¦¬ê³  ë‚˜ì„œ ê³µìœ í•˜ëŠ” ê³¼ì •ì´ ê·€ì°®ì•˜ëŠ”ì§€ ì ì  ì¹´í†¡ìœ¼ë¡œ ê³µìœ í•˜ê¸°ë¥¼ í•˜ì§€ ì•Šê¸° ì‹œì‘í–ˆë‹¤.ğŸ¥²

ê·¸ë™ì•ˆ í‘¸ì‹œ ì•Œë¦¼ì„ ê°œë°œí•˜ì§€ ì•Šì•˜ë˜ ì´ìœ ëŠ” iOS ì‚¬íŒŒë¦¬ì—ì„œëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì´ë‹¤. í•˜ì§€ë§Œ ì‘ë…„ 2023ë…„ì— iOSê°€ 16.4ë¡œ ì—…ë°ì´íŠ¸ë˜ë©´ì„œ ì‚¬íŒŒë¦¬ ë¸Œë¼ìš°ì €ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì§€ì›í•˜ê¸° ì‹œì‘í–ˆë‹¤. ê·¸ëŸ¬ë‹¤ ë³´ë‹ˆ ì¨ë³´ê³  ì‹¶ë‹¤ëŠ” ìƒê°ì„ ê³„ì† í•˜ëŠ” ë„ì¤‘ ê¸€ ë“±ë¡ì— ëŒ€í•´ ë‹µë‹µí•´ì§ˆ ì°°ë‚˜ ê·¸ëŸ¼ í‘¸ì‹œ ì•Œë¦¼ì„ ê°œë°œí•´ì•¼ê² ë‹¤ëŠ” ìƒê°ì„ í•˜ê²Œ ë˜ì—ˆë‹¤.

ë©¤ë²„ë“¤ì—ê²Œ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ì„ ê°œë°œí•  ìƒê°ì¸ë° ì–´ë–¤ ì•Œë¦¼ì„ ë°›ê³  ì‹¶ì€ì§€ ë¬»ì ì •ë§ ê¸°ë‹¤ë ¸ë‹¤ëŠ” ë“¯ì´ğŸ˜… ëŒ€ë‹µë“¤ì´ ì¤„ì¤„ì´ ìŸì•„ì ¸ ë‚˜ì™”ë‹¤. ì´ ì •ë„ë¡œ ëœ¨ê±°ìš´ ë°˜ì‘ì¼ ì¤„ì€ ëª°ëëŠ”ë° ë©¤ë²„ë“¤ë„ ì´ ê¸°ëŠ¥ì´ êµ‰ì¥íˆ ë°˜ê°€ì› ë‚˜ë³´ë‹¤. ê·¸ë˜ì„œ ì´ ë‹µë³€ë“¤ì„ ì¶”ë ¤ì„œ ê°œë°œì„ ì‹œì‘í–ˆê³  ì§€ê¸ˆ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì— ìˆë‹¤. ì˜ì™¸ë¡œ ìë£Œê°€ ë§ì§€ ì•Šì•„ì„œ ê°œë°œ ê³¼ì •ì´ ì •ë§ ì‰½ì§€ ì•Šì•˜ëŠ”ë°, ë‚´ê°€ ë¬´ì—‡ì„ êµ¬í˜„í•´ì•¼í•˜ëŠ”ì§€, ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë™ì§í•´ì•¼í•˜ëŠ”ì§€ í•˜ë‚˜í•˜ë‚˜ ìƒê°í•˜ë©´ì„œ ì–´ë–»ê²Œ ì½”ë“œë¥¼ ì¨ë‚´ë ¤ê°ˆì§€ ìƒê°í–ˆë‹¤. ì´ í¬ìŠ¤íŠ¸ì—ì„œ ì›¹ì˜ í‘¸ì‹œ ì•Œë¦¼ì„ êµ¬í˜„í•˜ëŠ” ê³¼ì •ì—ì„œ ì–´ë–¤ ë¡œì§ì„ ìƒê°í–ˆê³  ë²„ê·¸ë“¤ì´ ìˆì—ˆëŠ”ì§€ ë‹¤ì‹œ ê·¸ ê³¼ì •ì„ ëŒì´ì¼œë³´ë©° ë³µê¸°í•´ë³´ë ¤ê³  í•œë‹¤.

## í˜„ì¬ í”„ë¡œì íŠ¸ ìƒí™©ê³¼ ê°œë°œ ìš”êµ¬ì‚¬í•­

ë…ì„œëª¨ì„ í•œí˜ì´ì§€ ê¸°ë¡ì•±ì€ í”„ë¡ íŠ¸ì—”ë“œëŠ” `React`, ì„œë²„ëŠ” ì„œë²„ë¦¬ìŠ¤ì¸ `Firebase`ì—ì„œ 9ë²„ì „ìœ¼ë¡œ ê°œë°œë˜ì—ˆë‹¤.

```json:package.json
"react": "18.0.0",
"firebase": "^9.6.1",
```

ë”°ë¼ì„œ ë¯¸ë¦¬ ì´ì•¼ê¸°í•˜ìë©´ ì´í›„ í‘¸ì‹œ ì•Œë¦¼ë„ Firebaseë¥¼ í† ëŒ€ë¡œ FCM, Firebase Functionsë¥¼ í™œìš©í•´ì„œ ê°œë°œí•œë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì´ì œ í‘¸ì‹œ ì•Œë¦¼ê³¼ ê´€ë ¨ëœ ê°œë°œ ìš”êµ¬ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ì•Œë¦¼ ìˆ˜ì‹  : ìœ ì €ê°€ ì›¹ì•±ì„ ì—´ì–´ ë³´ê³  ìˆëŠ” ë™ì•ˆì— ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

2. ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ì•Œë¦¼ ìˆ˜ì‹  : ìœ ì €ê°€ ì•±ì„ êµ¬ë™í•˜ê³  ìˆì§€ ì•Šê³  ë‹«ê³  ìˆì„ ë•Œ ì•Œë¦¼ì„ ìˆ˜ì‹ í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

- ë‹¨, ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ì£¼ì²´ëŠ” ì•Œë¦¼ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤.

ìš”êµ¬ì‚¬í•­ì€ ë‹¨ ë‘ê°€ì§€ë¡œ ê°„ë‹¨í•˜ì§€ë§Œ ê·¸ ê³¼ì •ì´ ì •ë§ ê°„ë‹¨í•˜ì§€ ì•Šì•˜ë‹¤ğŸ˜…

## ì „ì²´ì ì¸ ê³¼ì • í›‘ì–´ë³´ê¸°

ê³µë¶€í•˜ë©´ì„œ ë§‰ êµ¬í˜„í–ˆì„ ë•ŒëŠ” ì´ê²ƒ ì €ê²ƒ ê³µë¶€í•˜ê³  ìƒê°í•˜ë©° ì‘ì„±í•˜ê³  ë‹¤ì‹œ ë˜ëŒë¦¬ëŠ” ë“± ì—¬ëŸ¬ ì‹œí–‰ì°©ì˜¤ë¥¼ ê±°ì³¤ëŠ”ë°, ë‹¤ì‹œ ì •ë¦¬í•˜ë©´ì„œ ì „ì²´ì ì¸ í° ê³¼ì •ì„ ì‘ì„±í•´ë³´ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ì„œ ì¼ë‹¨ ì‘ì„±í•´ë³´ë ¤ê³  í•œë‹¤. ì¼ë‹¨ í¬ê²Œ 4ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ì„œ ë³´ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤.

1ë‹¨ê³„ : ì¼ë‹¨ PWAë¡œ ë§Œë“¤ê³  í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°

2ë‹¨ê³„ : ìœ ì €ì˜ FCM ë°ì´í„°ì™€ ì €ì¥í•˜ê¸°

3ë‹¨ê³„ : Firebase Functionsì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ë³´ë‚¼ ì„œë²„ í•¨ìˆ˜ êµ¬í˜„í•˜ê¸°

4ë‹¨ê³„ : í† í° ê´€ë¦¬í•˜ê¸°

### 1ë‹¨ê³„ : ì¼ë‹¨ PWAë¡œ ë§Œë“¤ê³  í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°

1-1. PWAë¡œ ë§Œë“¤ì–´ì¤„ ì„œë¹„ìŠ¤ ì›Œì»¤ ì‘ì„±í•˜ê¸°

ê°€ì¥ ë¨¼ì € ì›¹ì•±ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìœ¼ë ¤ë©´ PWAë¡œ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ì›¹ì‚¬ì´íŠ¸ë¥¼ PWAë¡œ ì–´ë–»ê²Œ ë§Œë“œëŠ”ì§€ì— ëŒ€í•´ ì´ì•¼ê¸°í–ˆëŠ”ë°, ë‹µì€ **manifest.json** íŒŒì¼ê³¼ **ì„œë¹„ìŠ¤ ì›Œì»¤** íŒŒì¼ì„ ì‘ì„±í•˜ëŠ” ê²ƒì´ì—ˆë‹¤. manifest.jsonì€ ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ì„¤ì •í•œëŒ€ë¡œ ì˜ ì‘ì„±í•˜ë©´ ë˜ì§€ë§Œ, ì„œë¹„ìŠ¤ ì›Œì»¤ íŒŒì¼ì€ Firebaseì˜ ë§¥ë½ì—ì„œë¼ë©´ ì‘ì„±í•˜ëŠ” ë°©ë²•ì´ ì¡°ê¸ˆ ë‹¬ë¼ì§„ë‹¤. ì›¹ì•±ì— ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ë¶€í„° í•´ë³´ì!

ê¸°ì¡´ì— ì„œë¹„ìŠ¤ ì›Œì»¤ íŒŒì¼ì€ ê·¸ëƒ¥ `service-worker.js`ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ íŒŒì¼ì„ ìƒì„±í–ˆì§€ë§Œ Firebaseì™€ í•¨ê»˜ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ì‚¬ìš©í•˜ê³ ì í•œë‹¤ë©´ íŒŒì¼ëª…ì„ `firebase-messaging-sw.js`ë¡œ ì‘ì„±í•´ì£¼ì–´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  `index.html` íŒŒì¼ì´ ìˆëŠ” `public` í´ë” ì•ˆì— ë„£ì–´ì£¼ë©´ ëœë‹¤.

```javascript:public/firebase-messaging-sw.js
/* eslint-disable no-undef */
importScripts('https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js');

const firebaseConfig = {
  apiKey: process.env.REACT_APP_API_KEY,
  authDomain: process.env.REACT_APP_AUTH_DOMAIN,
  projectId: process.env.REACT_APP_PROJECT_ID,
  storageBucket: process.env.REACT_APP_STORAGE_BUCKET,
  messagingSenderId: process.env.REACT_APP_MESSAGING_SENDER_ID,
  appId: process.env.REACT_APP_APP_ID,
  measurementId: process.env.REACT_APP_MEASUREMENT_ID,
};

firebase.initializeApp(firebaseConfig);

/* eslint-disable no-restricted-globals */
/* âœ… ì„œë¹„ìŠ¤ ì›Œì»¤ ì„¤ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
self.addEventListener('install', function () {
  self.skipWaiting();
});

/* âœ… ì„œë¹„ìŠ¤ ì›Œì»¤ í™œì„±í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
self.addEventListener('activate', (e) => {
  e.waitUntil(
    clients.claim() // í´ë¼ì´ì–¸íŠ¸ ì œì–´ ê¶Œí•œ íšë“
  );
});

const messaging = firebase.messaging();

/* âœ… ë°±ê·¸ë¼ìš´ë“œ ìƒíƒœì¼ë•Œ ì•Œë¦¼ ìˆ˜ì‹  */
messaging.onBackgroundMessage((payload) => {
  console.log('Received background message: ', payload);

  const notificationTitle = payload.notification.title;
  const notificationOptions = { body: payload.notification.body };

  self.registration.showNotification(notificationTitle, notificationOptions);
});
```

ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ì„¤ì¹˜í•˜ê³  í™œì„±í™”í•˜ëŠ” ì´ë²¤íŠ¸ ì‘ì„± ì´ì™¸ì—ë„ Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê¸° ìœ„í•œ ì½”ë“œë¥¼ ì‘ì„±í•´ì¤€ë‹¤. ì£¼ì˜í•  ì ì€ `importScripts` ê°€ì ¸ì˜¨ë‹¤ë©´ ì£¼ì†Œì— `compat`ì´ ë“¤ì–´ê°€ëŠ”ì§€ ê¼­ í™•ì¸í•´ì•¼í•œë‹¤ëŠ” ì ì´ë‹¤. `compat`ì´ ì—†ì´ ì•ˆë‚´ë˜ê³  ìˆëŠ”ë°, ì´ ê²½ìš° ë¸Œë¼ìš°ì €ì—ì„œ ì„œë¹„ìŠ¤ ì›Œì»¤ëŠ” ES ëª¨ë“ˆì„ ì‚¬ìš©í•´ì•¼ í•˜ë©° `importScripts()`ì—ì„œ ë™ì  í˜¸ì¶œì€ ì œí•œì´ ìˆë‹¤ê³  í•œë‹¤.

[Firebase-JS-SDK Issue](https://github.com/firebase/firebase-js-sdk/issues/5403)  
[ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ ES ëª¨ë“ˆ](https://web.dev/articles/es-modules-in-sw?hl=ko)

ì´ë ‡ê²Œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê°€ì ¸ì™”ë‹¤ë©´ `firebaseConfig` ê°’ì„ ê°€ì ¸ì˜¨ë‹¤. `firebaseConfig` ê°’ì€ firebase consoleì—ì„œ í”„ë¡œì íŠ¸ ì„¤ì • í˜ì´ì§€ì˜ ì¼ë°˜ íƒ­ì— ë“¤ì–´ê°€ë©´ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° `firebaseConfig`ì—ì„œ `env` í™˜ê²½ë³€ìˆ˜ë¡œ ê°’ì„ ì‘ì„±í–ˆëŠ”ë° ì´ë ‡ê²Œ í•˜ë©´ ë°°í¬ í™˜ê²½ì—ì„œ ê°’ì„ ì¸ì‹í•˜ì§€ ëª»í•œë‹¤. ë”°ë¼ì„œ ë°°í¬ ë‹¨ê³„ì—ì„œëŠ” ì‹¤ì œ ê°’ì„ ì…ë ¥í•´ì£¼ì—ˆë‹¤. apiKeyë‚˜ id ê°’ ê°™ì€ ê²ƒì´ ìˆì–´ì„œ ê³µê°œë˜ì–´ë„ ê´œì°®ì€ê°€ ê±±ì •í–ˆëŠ”ë° ì´ firebaseConfig ì„¤ì •ê°’ë“¤ì€ í”„ë¡œì íŠ¸ì— ì—°ê²°ë§Œ ë  ë¿ ë³´ì•ˆìƒìœ¼ë¡œëŠ” ê´œì°®ë‹¤ê³  í•œë‹¤.

ê·¸ëŸ¼ ì´ì œ public í´ë”ì— ìˆëŠ” `index.html`ì—ì„œ ì´ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë¶ˆëŸ¬ì™€ ì„¤ì¹˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.

```html:index.html
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker
      .register('/han-bookclub-app/firebase-messaging-sw.js', {
        scope: '/han-bookclub-app/',
      })
      .then(
        function (registration) {
          console.log(
            'âœ…ServiceWorker registration successful with scope: ',
            registration.scope
          );
        },
        function (err) {
          console.log('âŒServiceWorker registration failed: ', err);
        }
      );
  }
</script>
```

ê·¸ë¦¬ê³  `index.html`ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¡œ `firebase-messaging-sw.js` íŒŒì¼ì„ ì‹¤í–‰í•´ì¤€ë‹¤. ì•„ë˜ ì˜ˆì‹œ ì½”ë“œì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ ì ì ˆí•œ íŒŒì¼ ê²½ë¡œë¥¼ ì‘ì„±í•´ì£¼ì–´ì•¼ í•œë‹¤. ë‚˜ëŠ” í˜„ì¬ gh-pagesë¡œ ë°°í¬ë¥¼ í–ˆê¸° ë•Œë¬¸ì— ë’¤ì— `/han-bookclub-app/`ê¹Œì§€ê°€ ë©”ì¸ ì£¼ì†Œë¼ì„œ ì•ì— ë¶™ì—¬ì£¼ì—ˆë‹¤. ê·¸ëŸ¼ ì´ì œ ë¹Œë“œë¥¼ í•´ì£¼ì.

![firebase-messaging-sw íŒŒì¼ ë“±ë¡ ì„±ê³µ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ console íƒ­](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/firebase-messaging-sw-console.png)

![firebase-messaging-sw íŒŒì¼ ë“±ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ” application íƒ­](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/firebase-messaging-sw-application.png)

ë¹Œë“œ ì´í›„ ì´ë ‡ê²Œ ê°œë°œì ë„êµ¬ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ íƒ­ì—ì„œ ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ í™œì„±í™”ëœ ê²ƒì´ ì˜ ë‚˜íƒ€ë‚˜ë©´ ì„±ê³µí•œ ê²ƒì´ë‹¤. ê·¸ëŸ¼ ì´ì œ **í† í°**ì„ ì–»ì–´ë³´ì!

---

1-2. ë¸Œë¼ìš°ì €ì— ì•Œë¦¼ í—ˆìš© ìš”ì²­í•˜ê³  í† í° ì–»ê¸°

í† í°ì€ FCMì´ í‘¸ì‹œ ì•Œë¦¼ì„ ì–´ë–¤ ê¸°ê¸°ì— ë³´ë‚´ì•¼ í• ì§€ ì•Œë ¤ì£¼ëŠ” ì•„ì£¼ ì¤‘ìš”í•œ ì •ë³´ì´ë‹¤. í† í°ì´ ì—†ë‹¤ë©´ ì ˆëŒ€ í‘¸ì‹œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ë‹¤. ê·¸ëŸ°ë° ì´ **í† í°ì€ ë¸Œë¼ìš°ì €ì—ì„œ ìœ ì €ê°€ ì•Œë¦¼ì„ í—ˆìš©í•œ ê²½ìš°ì—ë§Œ ë°œê¸‰**ëœë‹¤. ê·¸ë˜ì„œ ë¨¼ì € Notification APIì—ì„œ ì œê³µí•˜ëŠ” `Notification.requestPermission()`ì„ í†µí•´ ì•Œë¦¼ í—ˆìš© ìš”ì²­ì„ í•´ì•¼í•œë‹¤.

```javascript
const onPermitClick = async () => {
  if (!('Notification' in window)) {
    return alert('í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }

  if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      sendNotificationToCurrentUser(notificationData);
      saveFcmDataInDB();
    }
  }
};
```

ì¼ë‹¨ ë‚˜ëŠ” ì•Œë¦¼ ì•ˆë‚´ ë²„íŠ¼ì„ ë§Œë“¤ì–´ì„œ í—ˆìš©í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆë„ë¡ í–ˆë‹¤. ê·¸ëŸ¬ë©´ ì´ì œ ì•„ë˜ ì´ë¯¸ì§€ì™€ ê°™ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ì´ ì˜¨ë‹¤. ì—¬ê¸°ì„œ í—ˆìš©ì„ ëˆ„ë¥´ë©´ ëœë‹¤. ì°¨ë‹¨ì„ ëˆ„ë¥´ë©´ ì´ì œ ì§ì ‘ ì„¤ì •ì— ë“¤ì–´ê°€ì„œ ë³€ê²½í•´ì¤˜ì•¼í•œë‹¤.

![Pinterest PWA í™”ë©´](/public/images/web/completing-pwa-with-manifest-and-service-worker/pinterest-pwa.png)

ë§Œì•½ Reactì•± ë‚´ì—ì„œ Firebaseë¥¼ ì´ˆê¸°í™”í•˜ëŠ” íŒŒì¼ì„ ì‘ì„±í–ˆë‹¤ë©´ ê·¸ê³³ì—ì„œ ì•„ë˜ì™€ ê°™ì€ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤. `getToken`ì€ í˜„ì¬ ê¸°ê¸°ì˜ í† í°ì„ ì•Œë ¤ì£¼ëŠ” ì•„ì£¼ ì¤‘ìš”í•œ í•¨ìˆ˜ì´ë‹¤. ì´ë ‡ê²Œ í† í°ì„ ì–»ê¸° ìœ„í•œ ì•Œë¦¼ ê¶Œí•œë„ í—ˆìš©ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤ë©´, firebaseì—ì„œ ì œê³µí•˜ëŠ” í•¨ìˆ˜ì¸ `getToken`ì„ ì´ìš©í•˜ì—¬ í† í°ì„ ê°€ì ¸ì˜¤ì.

```javascript:firebase.ts
import { initializeApp } from 'firebase/app';
import { getMessaging, getToken, onMessage } from 'firebase/messaging';

const firebaseConfig = {
  apiKey: process.env.REACT_APP_API_KEY,
  authDomain: process.env.REACT_APP_AUTH_DOMAIN,
  projectId: process.env.REACT_APP_PROJECT_ID,
  storageBucket: process.env.REACT_APP_STORAGE_BUCKET,
  messagingSenderId: process.env.REACT_APP_MESSAGING_SENDER_ID,
  appId: process.env.REACT_APP_APP_ID,
  measurementId: process.env.REACT_APP_MEASUREMENT_ID,
};

export const app = initializeApp(firebaseConfig);

const messaging = getMessaging(app);

// âœ…í¬ê·¸ë¼ìš´ë“œ ìƒíƒœì¼ë•Œ ì•Œë¦¼ ì²˜ë¦¬
onMessage(messaging, (payload) => {
  console.log('Message received. ', payload);
  const notificationTitle = payload.notification.title
  const notificationOption = {
    body: payload.notification.body
  }

  const notification = new Notification(notificationTitle, notificationOption)
});

// âœ…í† í° ê°€ì ¸ì˜¤ê¸°
export const getDeviceToken = async () => {
  return getToken(messaging, {
    vapidKey: process.env.REACT_APP_MESSAGING_TOKEN,
    serviceWorkerRegistration: await navigator.serviceWorker.register(
      '/han-bookclub-app/firebase-messaging-sw.js'
    ),
  });
};
```

ê¸°ì¡´ì— ì‘ì„±í–ˆë˜ firebase ê´€ë ¨ íŒŒì¼ì´ ìˆì„ ê²ƒì´ë‹¤. ë‚˜ëŠ” í•´ë‹¹ íŒŒì¼ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì—ˆë‹¤. `getToken`í•¨ìˆ˜ëŠ” ë‘ê°€ì§€ ì¸ìê°€ ë“¤ì–´ê°€ëŠ”ë°, `validKey`ì—ëŠ” firebase ì½˜ì†”ì˜ í”„ë¡œì íŠ¸ ì„¤ì • > í´ë¼ìš°ë“œ ë©”ì‹œì§• íƒ­ì— ë“¤ì–´ê°€ì„œ í•˜ë‹¨ì˜ ì›¹ í‘¸ì‹œ ì¸ì¦ì„œì˜ í‚¤ìŒì„ ë°œê¸‰ë°›ì€ ê°’ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ë‘ë²ˆì§¸ ì¸ìì¸ `serviceWorkerRegistration`ì—ëŠ” ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ ë“±ë¡ëœ ìœ„ì¹˜ë¥¼ ì‘ì„±í•´ì£¼ë©´ ëœë‹¤.

ê·¸ë¦¬ê³  í† í°ì´ í•„ìš”í•œ ê³³ì— ê°€ì ¸ì™€ì„œ ì½˜ì†”ì— ì°ì–´ë³´ë©´ ì´ë ‡ê²Œ í† í°ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```javascript:App.tsx
getDeviceToken()
  .then((token) => console.log("ğŸ”token:", token));
```

![ì½˜ì†”ì—ì„œ ë³´ì´ëŠ” í† í°](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/console-token.png)

í† í°ì„ ì–»ì—ˆë‹¤ë©´ Firebase ì½˜ì†”ì—ì„œ FCM ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ê³  ì•Œë¦¼ì„ í…ŒìŠ¤íŠ¸í•´ë³¸ë‹¤.

---

1-3. FCM ì½˜ì†”ì—ì„œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸í•´ë³´ê¸°

í† í°ì„ ê°€ì ¸ì™”ë‹¤ë©´ ì´ì œ ì´ í† í°ìœ¼ë¡œ ì•Œë¦¼ì´ ì˜ ì˜¤ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•´ë³¼ ì°¨ë¡€ë‹¤. í˜¹ì‹œ Firebase ì½˜ì†”ì—ì„œ ì•„ì§ FCM ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•˜ì§€ ì•Šì•˜ë‹¤ë©´ í™œì„±í™”í•œë‹¤.

![fcm ì½˜ì†” í™”ë©´](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/fcm-console.png)

ê·¸ëŸ¼ ì´ì œ ì²«ë²ˆì§¸ ìº í˜ì¸ ì—´ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ê³ 

![fcm ì½˜ì†” ì•Œë¦¼ í…ŒìŠ¤íŠ¸](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/fcm-test.png)

ì—¬ê¸°ì„œ ë‚˜ì²˜ëŸ¼ ë‹¹í™©í•˜ì§€ ì•Šì•˜ìœ¼ë©´ í•˜ëŠ” ë§ˆìŒì— ë§ë¶™ì—¬ ì´ì•¼ê¸°í•˜ìë©´, ìœ„ì˜ í…ŒìŠ¤íŠ¸ ì°½ì—ì„œ í† í°ì„ ì¶”ê°€í•  ë•Œ ëŒ€ì²´ ì–´ë””ì— ì¶”ê°€í•´ì•¼í•˜ëŠ”ê±´ì§€ ì…ë ¥ì°½ì´ ë³´ì´ì§€ê°€ ì•Šì•„ì„œ êµ‰ì¥íˆ í—¤ë§¸ë‹¤. ê·¸ëŸ°ë° ë²„íŠ¼ì²˜ëŸ¼ ë³´ì´ëŠ” **FCM ë“±ë¡ í† í° ì¶”ê°€**ë¼ê³  ì í˜€ ìˆëŠ” ë¶€ë¶„ì´ ì‚¬ì‹¤ì€ ì…ë ¥ì°½ì´ì—ˆë‹¤. ì € ë¶€ë¶„ì„ í´ë¦­í•´ë³´ë©´ ì»¤ì„œê°€ ê¹œë°•ì´ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤. ê·¸ê³³ì— `getToken`ì„ í†µí•´ ì–»ì€ í† í°ì„ ì¶”ê°€í•´ì¤€ë‹¤.

ê·¸ë¦¬ê³  í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ë©´

![ì½˜ì†”ì—ì„œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/test-message.png)

ì•Œë¦¼ì´ ì˜ ìˆ˜ì‹ ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ë§Œì•½ ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ì´ ì˜¤ì§€ ì•ŠëŠ”ë‹¤ë©´ ì„¤ì •ì— ë“¤ì–´ê°€ì„œ **ì•Œë¦¼ ì„¤ì •ì— í¬ë¡¬ì´ í—ˆìš©ë˜ì–´ ìˆëŠ”ì§€** ì‚´í´ë´ì•¼í•œë‹¤!

ì—¬ê¸°ê¹Œì§€ í† í°ì„ ì´ìš©í•´ í˜„ì¬ ê¸°ê¸°ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì´ ì˜ ì˜¤ëŠ”ì§€ í™•ì¸í•´ë³´ëŠ” ê³¼ì •ì„ ë§ˆì³¤ë‹¤.

ìš”êµ¬ì‚¬í•­ì—ì„œë„ ë³´ì•˜ë“¯ì´ ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ì£¼ì²´ ì´ì™¸ì˜ ëª¨ë“  ë©¤ë²„ê°€ ë°±ê·¸ë¼ìš´ë“œë‚˜ í¬ê·¸ë¼ìš´ë“œì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ ìˆ˜ì‹ í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ê·¸ë ‡ë‹¤ë©´ ì´ì œ í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ë  ê²ƒì´ ì•„ë‹ˆë¼ **ì„œë²„**ê°€ í•„ìš”í•  ë•Œë‹¤.

### 2ë‹¨ê³„ : ìœ ì €ì˜ FCM ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸°

2-1. ìœ ì €ì˜ ì•Œë¦¼ í—ˆìš© ì—¬ë¶€ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•œë‹¤.

í† í°ì„ ë°œê¸‰ë°›ìœ¼ë ¤ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤ê³  í–ˆë‹¤. ë‚˜ëŠ” ì´ í‘¸ì‹œ ì•Œë¦¼ ëª¨ë‹¬ì„ ë§Œë“¤ì–´ì„œ í—ˆìš©í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‚˜íƒ€ë‚˜ë„ë¡ ë§Œë“¤ì—ˆë‹¤.

![notification-modal](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/notification-modal.png)

ìœ ì €ê°€ í—ˆìš©í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— notification ë¼ëŠ” í‚¤ì— "granted", ê±°ì ˆí•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ "denied" ì €ì¥í•œë‹¤.

```javascript
const onPermitClick = async () => {
  if (!('Notification' in window)) {
    return alert('í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }

  if (Notification.permission === 'granted') {
    sendNotificationToCurrentUser(notificationData);
    saveFcmDataInDB();
  } else if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      sendNotificationToCurrentUser(notificationData);
      saveFcmDataInDB();
    }
  }
  handleLocalStorage('set', true);
  toggleModal();
};
```

2-2. í—ˆìš©í•˜ê¸°ë¥¼ ëˆŒë €ë‹¤ë©´ FireStoreì— FCM ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤.

ìœ ì €ê°€ ì•Œë¦¼ í—ˆìš©í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš° í† í°ì„ ë¹„ë¡¯í•œ FCM ë°ì´í„°ë¥¼ FireStore ë°ì´í„°ë² ì´ìŠ¤ ë¬¸ì„œì— ì €ì¥í•œë‹¤. ë‚˜ëŠ” FCMì´ë¼ëŠ” ìƒˆë¡œìš´ ì»¬ë ‰ì…˜ì„ ë§Œë“¤ì–´ì„œ ê° ìœ ì €ë³„ë¡œ ë¬¸ì„œë¥¼ ë§Œë“¤ì–´ ë°ì´í„°ë¥¼ ì €ì¥í–ˆë‹¤.

```javascript
const fcmData = {
  createdAt: ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œ ì‹œê°„,
  notification: "granted",
  tokens: [í† í°1, í† í°2, ...]
}
```

### 3ë‹¨ê³„ : í‘¸ì‹œ ì•Œë¦¼ì„ ë³´ë‚¼ ì„œë²„ í•¨ìˆ˜ êµ¬í˜„í•˜ê¸°

3-1. Firebase Functionsë¥¼ í™˜ê²½ ë§Œë“¤ê¸°

ìœ ì €ì˜ FCM í† í° ì •ë³´ê¹Œì§€ ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ ì €ì¥í–ˆë‹¤. ê·¸ëŸ¼ ì´ì œ í‘¸ì‹œ ì•Œë¦¼ì„ ë³´ë‚¼ ì„œë²„ë¥¼ ë§Œë“¤ì–´ë³´ë ¤ê³  í•œë‹¤. ì„œë²„ëŠ” ê³ ë¯¼ì„ ë§ì´ í–ˆë‹¤. Node.jsë¡œ ë§Œë“¤ì–´ì„œ ì„œë²„ë¥¼ ë°°í¬í•´ì•¼í• ê¹Œ? í•˜ì§€ë§Œ ì•Œë¦¼ì´ ê·¸ë ‡ê²Œ ë§ì´ ê°€ëŠ” ê²ƒì´ ì•„ë‹Œë° ì„œë²„ê¹Œì§€ ë§Œë“¤ì–´ì„œ 24ì‹œê°„ ë§¤ì¼ ì„œë²„ê°€ ëŒì•„ê°€ê³  ìˆëŠ” ê²ƒì´ ë‚­ë¹„ê°™ì•˜ë‹¤. ê·¸ë¦¬ê³  í˜„ì¬ í”„ë¡œì íŠ¸ì— Firebaseë¥¼ ì“°ê³  ìˆëŠ”ë° ì„œë²„ í•¨ìˆ˜ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì¸ Firebase Functionsë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì´ ë” ë§ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.

[Firebase Functions ì‹œì‘í•˜ê¸°](https://firebase.google.com/docs/functions/get-started?hl=ko&_gl=1*1wn2txp*_up*MQ..*_ga*MTk4NjU3MzY4NC4xNzE4MDAzMDE3*_ga_CW55HF8NVT*MTcxODAwMzAxNi4xLjAuMTcxODAwMzAxNi4wLjAuMA..&gen=2nd)

Firebase Functions ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Firebase ìš”ê¸ˆì œê°€ Blazeì—¬ì•¼ í•œë‹¤. ë¨¼ì € ìš”ê¸ˆì œë¥¼ ë³€ê²½í•œ ë’¤, Firebase Functions ê³µì‹ë¬¸ì„œì— ì•ˆë‚´ë˜ëŠ”ëŒ€ë¡œ ì½˜ì†”ê³¼ í”„ë¡œì íŠ¸ë¥¼ ì„¤ì •í–ˆë‹¤.

ì´ì— ë”°ë¼ í”„ë¡œì íŠ¸ í´ë” êµ¬ì¡°ë„ ë°”ë€Œì—ˆëŠ”ë°, ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ì˜ êµ¬ë¶„ì„ ìœ„í•´ clientì™€ server í´ë”ë¥¼ ìƒì„±í•˜ì—¬ ê¸°ì¡´ Reactì˜ íŒŒì¼ë“¤ì€ client í´ë”ì— ë„£ê³  í˜„ì¬ ë§Œë“œëŠ” firebase functionsì˜ ì½”ë“œë“¤ì€ server í´ë” ë‚´ì— ë„£ì—ˆë‹¤.

```bash
.root
â”œâ”€â”€ client
â”œâ”€â”€ node_modules
â”œâ”€â”€ server
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

```bash
.root
â”œâ”€â”€ server
â”‚   â”œâ”€â”€ functions
â”‚   â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”œâ”€â”€ node_modules
â”‚   â”‚   â”œâ”€â”€ src
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ src
â”‚   â”œâ”€â”€ .eslintrc.cjs
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ .firestore.indexes.json
â”‚   â”œâ”€â”€ .firestore.rules
â”œâ”€â”€ #...ìƒëµ
```

ìœ„ì™€ ê°™ì´ server í´ë” êµ¬ì¡°ë¥¼ ìƒì„±í–ˆë‹¤.

ì¶”ê°€ë¡œ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ë¥¼ í•œë²ˆì— ì‹¤í–‰í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ë§Œë“¤ë©´ í¸í•  ê²ƒ ê°™ì•„ì„œ í”„ë¡œì íŠ¸ root ë¶€ë¶„ì— package.jsonì„ ë§Œë“¤ê³  ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í–ˆë‹¤.

```json:package.json
{
  "scripts": {
    "client": "cd client && npm start",
    "server": "cd server/functions && npm run serve",
    "dev": "concurrently --kill-others-on-fail \"npm run server\" \"npm run client\""
  },
  "dependencies": {
    "concurrently": "^8.2.2"
  }
}
```

rootì—ì„œ ë°”ë¡œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ëœë‹¤.

```bash
npm run dev
```

---

3-2. í‘¸ì‹œ ì•Œë¦¼ì„ ë³´ë‚¼ ì„œë²„ í•¨ìˆ˜ ë§Œë“¤ê¸°

ê·¸ëŸ¼ ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ í‘¸ì‹œ ì•Œë¦¼ì„ ë³´ë‚¼ ì„œë²„ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ë³´ì. í˜„ì¬ ë‚˜ì˜ ì„¤ì¹˜í•œ ë²„ì „ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```json:server/functions
"dependencies": {
  "firebase-admin": "^12.1.0",
  "firebase-functions": "^5.0.0"
  },
  // ìƒëµ...
```

firebase functionì—ì„œ fcmì„ ì„¤ì •í•˜ëŠ” ë°©ë²•ìœ¼ë¡œëŠ”

1. HTTP ìš”ì²­ì„ í†µí•´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹
2. í´ë¼ì´ì–¸íŠ¸ ì•±ì—ì„œ Firebase Admin SDKë¥¼ ì´ìš©í•´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹

ì´ë ‡ê²Œ ë‘ê°€ì§€ê°€ ìˆë‹¤.

[FCM ì„œë²„ ì˜µì…˜ ì„ íƒ](https://firebase.google.com/docs/cloud-messaging/server?hl=ko&_gl=1*dim01k*_up*MQ..*_ga*MTIwMTg1MTgwMS4xNzE4MzYyMjcw*_ga_CW55HF8NVT*MTcxODM2MjI2OS4xLjAuMTcxODM2MjI2OS4wLjAuMA..#choosing-a-server-option)

ë‚˜ëŠ” ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì—†ì´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê·¸ëƒ¥ ë°”ë¡œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ë˜ëŠ” ë°©ì‹ì´ êµ‰ì¥íˆ í¸ë¦¬í•  ê²ƒ ê°™ì•„ì„œ Firebase Admin SDKë¥¼ í†µí•´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ì„ íƒí–ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë ¤ë©´ `onRequest`ë¥¼ ì¨ì•¼í•˜ì§€ë§Œ Firebase Admin SDKë¥¼ í†µí•´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë ¤ë©´ `onCall`ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```javascript:server/functions/src/index.ts
import { onCall, HttpsError } from 'firebase-functions/v2/https';
import admin from 'firebase-admin';

admin.initializeApp();

const db = admin.firestore();

// ì•„ë˜ ì„œë²„ í•¨ìˆ˜ ì‘ì„±
```

```javascript:client/src/firebase.ts
import { initializeApp } from 'firebase/app';
import { getMessaging, getToken } from 'firebase/messaging';
import { connectFunctionsEmulator } from 'firebase/functions';

// ...ìƒëµ

const messaging = getMessaging(app);
const functions = getFunctions();

// âœ… ë¡œì»¬ í™˜ê²½ì—ì„œ ì„œë²„ í•¨ìˆ˜ë¥¼ ì‘ë™ì‹œí‚¤ëŠ” ì—ë®¬ë ˆì´í„° ê°€ë™
if (process.env.NODE_ENV === 'development') {
  connectFunctionsEmulator(functions, 'localhost', 5001);
}
```

ê·¸ë ‡ë‹¤ë©´ ì•„ê¹Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ firebaseë¥¼ ì´ˆê¸°í™”í•´ì£¼ëŠ” íŒŒì¼ì—ì„œ firebase functions ê´€ë ¨ í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ì¤€ë‹¤. `connectFunctionsEmulatorë„` ê°™ì´ ì„¤ì •í•´ì£¼ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„œë²„ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆë‹¤.

#### íŠ¹ì • ìœ ì €ì—ê²Œ í‘¸ì‹œ ì•Œë¦¼ ë³´ë‚´ê¸°

ì—¬ê¸°ì„œ ì„œë²„ í•¨ìˆ˜ë¥¼ ì‘ì„±í•˜ë©° ì•Œë¦¼ì„ í…ŒìŠ¤íŠ¸í•˜ë©´ì„œ êµ‰ì¥íˆ ë§ì´ í—¤ë§¸ë‹¤. ì¼ë‹¨ íŠ¹ì • ìœ ì €ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚´ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í–ˆëŠ”ë° ì™„ì„± ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```javascript:server/functions/src/index.ts
export const sendUnicast = onCall(async (request: { data: FcmUnicastData }) => {
  const {
    data: { token, title, body, link },
  } = request;

  if (!token) {
    throw new HttpsError('not-found', 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
  }

  const message = {
    data: {
      title,
      body,
      link,
    },
    token,
  };

  try {
    const response = await admin.messaging().send(message);
    return { success: true, response };
  } catch (error) {
    console.log('Error sending message:', error);
    throw new HttpsError(
      'internal',
      'ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      error
    );
  }
});
```

íŠ¹ì • í•œ ìœ ì €ì—ê²Œë§Œ ì•Œë¦¼ì„ ë³´ë‚¼ ë–„ëŠ” í•´ë‹¹ ìœ ì €ì˜ í† í°ë§Œ ê°€ì ¸ì™€ì„œ `send` ë©”ì„œë“œë¥¼ í†µí•´ ì•Œë¦¼ ê´€ë ¨ ì •ë³´ë§Œ ë³´ë‚´ì£¼ë©´ ë˜ê¸° ë•Œë¬¸ì— ë¹„êµì  ê°„ë‹¨í•œ í¸ì´ë‹¤. ê·¸ëŸ°ë° ë¬¸ì œê°€ ìˆì—ˆë‹¤. ê°œë°œ í™˜ê²½ì—ì„œ Foregroundë‚˜ Background ìƒíƒœì—ì„œ ì˜ ìˆ˜ì‹ ë˜ëŠ” ê²ƒì„ í™•ì¸í–ˆëŠ”ë°, ë°°í¬í•˜ê³  ë‚˜ì„œê°€ ë¬¸ì œì˜€ë‹¤. ë°ìŠ¤í¬íƒ‘ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Foregroundë‚˜ Background ìƒíƒœì—ì„œ ëª¨ë‘ ì•Œë¦¼ì„ ì˜ ìˆ˜ì‹ í–ˆì§€ë§Œ, ìŠ¤ë§ˆíŠ¸í° ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Foreground ìƒíƒœì—ì„œ ì•Œë¦¼ì„ ìˆ˜ì‹ í•˜ì§€ ëª»í–ˆë‹¤. ê·¸ë˜ì„œ ìŠ¤ë§ˆíŠ¸í°ì„ ë…¸íŠ¸ë¶ê³¼ ì—°ê²°í•´ ë””ë²„ê¹…í•œ ê²°ê³¼ ì„œë²„ê°€ ë¬¸ì œë¼ëŠ” 500 ì—ëŸ¬ë§Œ ê³„ì† ë°œìƒí–ˆë‹¤.

ê·¸ë˜ì„œ ì•Œë¦¼ ë°œì†¡ ê²°ê³¼ì—ì„œ

```json
{
  "verifications": {
    "app": "MISSING", // â—ï¸appì´ MISSING
    "auth": "VALID"
  },
  "logging.googleapis.com/labels": {
    "firebase-log-type": "callable-request-verification"
  },
  "severity": "DEBUG",
  "message": "Callable request verification passed"
}
```

appì´ Missingì´ë¼ê³  ëœ¨ëŠ”ê²Œ ì›ì¸ì¸ê°€ ì‹¶ì–´ì„œ App Check ì„¤ì •ê¹Œì§€ ë§ˆì³¤ëŠ”ë°ë„ Foreground ìƒíƒœì—ì„œ ì•Œë¦¼ì€ ìˆ˜ì‹ ë˜ì§€ ì•Šì•˜ë‹¤. ì™œ `onMessage`ê°€ ì‘ë™ì„ ì•ˆí•˜ëŠ”ì§€ ê³„ì† ë””ë²„ê¹…ì„ í•´ë³´ë‹¤ê°€ ì„œë¹„ìŠ¤ ì›Œì»¤ì—ì„œ `onBackgroundMessage`ë¥¼ `push` ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ë³€ê²½í•´ë³´ì•˜ë‹¤.

```javascript:firebase-messaging-sw.js
// ìœ„ì™€ ë™ì¼ ìƒëµ...

/* â—ï¸ ë°±ê·¸ë¼ìš´ë“œ ìƒíƒœì¼ë•Œ ì•Œë¦¼ ìˆ˜ì‹ 
// messaging.onBackgroundMessage((payload) => {
//   console.log('Received background message: ', payload);

//   const notificationTitle = payload.notification.title;
//   const notificationOptions = { body: payload.notification.body };

//   self.registration.showNotification(notificationTitle, notificationOptions);
// });

/* âœ… í‘¸ì‰¬ ì´ë²¤íŠ¸ë¡œ ë³€ê²½ */
self.addEventListener('push', function (event) {
  if (event.data) {
    const {
      data: { title, body, link },
    } = event.data.json();

    const options = {
      body,
      data: {
        link,
      },
    };

    event.waitUntil(self.registration.showNotification(title, options));
  } else {
    console.log('í‘¸ì‹œ ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
});
```

ì´ë ‡ê²Œ ë³€ê²½í–ˆë”ë‹ˆ ê°œë°œê³¼ ë°°í¬ í™˜ê²½, í¬ê·¸ë¼ìš´ë“œì™€ ë°±ê·¸ë¼ìš´ë“œ ëª¨ë‘ ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì‹ ë˜ì—ˆë‹¤. ëŒ€ì²´ ì™œ `onMessage`ê°€ ì™œ ë°°í¬í™˜ê²½ì—ì„œ ì‘ë™ì„ ì•ˆí•˜ëŠ”ì§€ ì›ì¸ì„ ì°¾ì•„ë³´ì•˜ìœ¼ë‚˜ ì •í™•í•˜ê²Œ ì•Œì§„ ëª»í–ˆë‹¤. í•˜ì§€ë§Œ ì•„ë§ˆ ì¶”ì¸¡í•˜ê¸°ë¡  ë‚˜ì˜ ë²„ì „ë¬¸ì œ ë•Œë¬¸ì¸ ê²ƒ ê°™ì•˜ë‹¤.  
[Firebase Blog: fcm for safari ](https://firebase.blog/posts/2023/08/fcm-for-safari/)  
 9.6.1 ë²„ì „ì—ì„œëŠ” ì•„ì§ Firebaseê°€ í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í–ˆê¸° ë•Œë¬¸ì´ë‹¤. ì•„ì‹œëŠ” ë¶„ì€ ì•Œë ¤ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.ğŸ™‚ ë‹¤í–‰íˆ í•´ê²°ì±…ì„ ì°¾ì•„ì„œ `onMessage`ì™€ `onBackgroundMessage` ê´€ë ¨ ì½”ë“œë¥¼ ì§€ìš°ê³  `push` ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ì ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.

ì£¼ì˜í•  ì ì€ ì´ ë°©ë²•ìœ¼ë¡œ í•˜ë ¤ë©´ ì•Œë¦¼ì„ ëª¨ë‘ dataë¥¼ í‚¤ë¡œ ê°€ì§„ ê°ì²´ê°’ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤.

```javascript
// â­•ï¸
const message = {
  data: {
    title,
    body,
    link,
  },
  token,
};

// âŒ
const message = {
  notification: {
    title,
    body,
  }
  webpush: {
    fcmOtions: {
      link
    }
  }
  token,
};
```

ì„œë²„ í•¨ìˆ˜ì—ì„œëŠ” ì•Œë¦¼ ì •ë³´ë¥¼ ë°ì´í„° í˜•ì‹ìœ¼ë¡œë§Œ ì œê³µí•´ì£¼ê³ , ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ `push` ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì´ ì•Œë¦¼ì„ ìˆ˜ì‹ í•´ì¤€ë‹¤. ë§Œì•½ `notification`ì„ í‚¤ë¡œ ê°€ì§„ ê°ì²´ê°’ì„ ê°™ì´ ì‘ì„±í•  ê²½ìš° **ì•Œë¦¼ì´ ì¤‘ë³µ**ìœ¼ë¡œ ì˜¤ê²Œ ë˜ë‹ˆ ì£¼ì˜í•´ì•¼ í•œë‹¤.

#### ì—¬ëŸ¬ ìœ ì €ì—ê²Œ í‘¸ì‹œ ì•Œë¦¼ ë³´ë‚´ê¸°

```javascript:server/functions/src/index.ts
// ìƒëµ...

const db = admin.firestore();

export const sendMulticast = onCall(
  async (request: { data: FcmMulticastData }) => {
    const {
      data: { title, body, link, uid },
    } = request;

    const tokensSnapshot = await db.collection('FCMNotification').get();
    const tokens = tokensSnapshot.docs
      .filter((doc) => doc.id !== uid)
      .map((doc) => doc.data().tokens)
      .flat()
      .filter((token) => typeof token === 'string' && token.trim() !== '');

    if (tokens.length === 0) {
      throw new HttpsError('not-found', 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
    }

    const message = {
      data: {
        title,
        body,
        link,
      },
      tokens,
    };

    try {
      const response = await admin.messaging().sendEachForMulticast(message);
      return { success: true, response };
    } catch (error) {
      console.log('Error sending message:', error);
      throw new HttpsError(
        'internal',
        'ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        error
      );
    }
  }
);
```

ì—¬ëŸ¬ ìœ ì €ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚´ë ¤ê³  í•  ë•ŒëŠ” `sendEachForMulticast` ë©”ì„œë“œë¥¼ ì‚¬ìš©í–ˆë‹¤. í•´ë‹¹ ë©”ì„œë“œëŠ” ì–´ë–¤ ì•Œë¦¼ì´ ì„±ê³µí–ˆê³  ì‹¤íŒ¨í–ˆëŠ”ì§€ ê²°ê³¼ê¹Œì§€ ìƒì„¸í•˜ê²Œ ì•Œë ¤ì¤€ë‹¤. ê·¸ë¦¬ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ FireStoreì— ì €ì¥í•œ ìœ ì €ì˜ í† í°ë“¤ì„ ë¶ˆëŸ¬ì™€ì„œ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ë§Œë“¤ì–´ì£¼ì—ˆê³ , í•´ë‹¹ í† í°ë“¤ë¡œ ì•Œë¦¼ì„ ë³´ë‚´ì£¼ì—ˆë‹¤.

ì•Œë¦¼ì„ ì˜ ë§Œë“  ê²ƒì„ í™•ì¸í•œ í›„ì— Firebase Functionsì— ì €ì¥í•´ì£¼ë©´ ëœë‹¤.

```bash
firebase deploy --only functions
```

ë§Œì•½ í•¨ìˆ˜ í•˜ë‚˜ë§Œ ìˆ˜ì •í•´ì„œ ì €ì¥í•˜ê³  ì‹¶ì€ ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•´ì£¼ë©´ ëœë‹¤.

```bash
firebase deploy --only functions:sendUnicast
```

ì´ë ‡ê²Œ ì„œë¹„ìŠ¤ì— ì„œë²„ í•¨ìˆ˜ë“¤ì„ ì˜ ë“±ë¡í•´ì£¼ì—ˆë‹¤ë©´ ì½˜ì†”ì— ì´ë ‡ê²Œ í•¨ìˆ˜ë“¤ì´ ì˜ ëœ° ê²ƒì´ë‹¤.

![firebase-functions](/public/images/web/how-to-implement-push-notifications-with-fcm-and-firebase-functions/firebase-functions.png)

ì„œë²„ í•¨ìˆ˜ë“¤ì„ ì˜ ë“±ë¡í–ˆë‹¤ë©´ ì´ì œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ `getFunctions`, `httpsCallable`ì„ ì´ìš©í•˜ì—¬ ë¶ˆëŸ¬ì˜¨ë‹¤. ê·¸ëŸ¼ í•´ë‹¹ ì„œë²„ í•¨ìˆ˜ë“¤ì„ ì´ì œ ììœ ìì¬ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

```javascript:firebase.ts
//ìƒëµ...
import {
  connectFunctionsEmulator,
  getFunctions,
  httpsCallable,
} from 'firebase/functions';

interface NotificationData {
  title: string;
  body: string;
  link: string;
}

export interface FcmUnicastData extends NotificationData {
  token: string;
}

export interface FcmMulticastData extends NotificationData {
  uid: string;
}

interface CallableResult {
  successCount: number;
  failureCount: number;
}

//ìƒëµ...

export const sendUnicast = httpsCallable<FcmUnicastData, CallableResult>(
  functions,
  'sendUnicast'
);

export const sendMulticast = httpsCallable<FcmMulticastData, CallableResult>(
  functions,
  'sendMulticast'
);
```

## í† í° ê´€ë¦¬

ì•Œë¦¼ì„ ì˜ ë°œì†¡í•˜ê³  ìˆ˜ì‹ ë˜ëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤ë©´ ì´ì œ í† í°ì„ ì–´ë–»ê²Œ ê´€ë¦¬í•´ì•¼í• ì§€ ìƒê°í•´ë³´ì•„ì•¼í•  ì°¨ë¡€ì´ë‹¤. ë…ì„œëª¨ì„ í•œí˜ì´ì§€ ì„œë¹„ìŠ¤ëŠ” ì‹¤ì œ ìœ ì €ë“¤ì´ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ì´ê¸° ë•Œë¬¸ì— ë”ìš±ë” í‘¸ì‹œ ì•Œë¦¼ì— ëŒ€í•œ ê´€ë¦¬ë¥¼ í•´ì•¼í–ˆë‹¤. ì–´ë–¤ ìœ ì €ëŠ” ì•Œë¦¼ì„ ë°›ì•˜ëŠ”ë° ì–´ë–¤ ìœ ì €ëŠ” ëª»ë°›ìœ¼ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ëŸ°ë° í† í°ì€ ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½ë  ìˆ˜ ìˆê³ , ë˜ ì‚¬ìš©ìê°€ ì•±ì„ ì‚­ì œí•œë‹¤ë˜ê°€, ìºì‹œë¥¼ ì‚­ì œí•œë‹¤ëŠ” ì´ìœ  ë“±ë“±ìœ¼ë¡œ ê°‘ìê¸° ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì´ ë  ìˆ˜ ìˆë‹¤. ê·¸ë ‡ê²Œ ë˜ë©´ ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì— ê³„ì† ë¬´ì˜ë¯¸í•œ ì„œë²„ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ê¼´ì´ ëœë‹¤. ê·¸ë˜ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ êµ¬í˜„í•œ ì´í›„ì— í† í° ê´€ë¦¬ë¥¼ ì–´ë–»ê²Œ í• ì§€ ë§ì´ ê³ ë¯¼í–ˆë‹¤.

ê³µì‹ë¬¸ì„œì—ì„œë„ í† í°ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•˜ê³  ìˆë‹¤.  
[FCM ë“±ë¡ í† í° ê´€ë¦¬ë¥¼ ìœ„í•œ ê¶Œì¥ì‚¬í•­](https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ko)

ê³µì‹ë¬¸ì„œì— ë‚˜ì˜¨ ë‚´ìš©ì€

- ê¸°ë³¸ ê¶Œì¥ì‚¬í•­

  1. ì„œë²„ì— í† í°ì„ ì €ì¥í•œë‹¤.

     ì•ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— FCMê³¼ ê´€ë ¨í•´ í† í° ë°ì´í„°ë¥¼ ì €ì¥í–ˆë‹¤.

  2. ì €ì¥ëœ í† í° ì¤‘ ë¹„í™œì„±í™”ëœ í† í°ì„ ì‚­ì œí•œë‹¤.

     ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´ì„œ ë¹„í™œì„±í™”ëœ í† í°ë“¤ì´ ë°œìƒí–ˆê³  ì „ì†¡ ì‹¤íŒ¨ ê²°ê³¼ê°€ ë–´ë‹¤. í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” í† í°ì„ ë°°ì—´ì— ì¶”ê°€ë§Œ í•˜ê¸° ë•Œë¬¸ì— ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ë“¤ì€ ê³„ì† ìŒ“ì¼ ê²ƒì´ì—ˆë‹¤. ê·¸ë˜ì„œ ì–´ë–»ê²Œ í• ì§€ ê³ ë¯¼í•˜ë‹¤ê°€ ì¼ë‹¨ ì•Œë¦¼ì„ ë³´ë‚´ê³  ì‹¤íŒ¨ ê²°ê³¼ê°€ ëœ¬ í† í°ë“¤ì€ ë¬¸ì„œì—ì„œ ì‚­ì œí•˜ê¸°ë¡œ í–ˆë‹¤.

     ```javascript:server/functions/index.ts
     // ìƒëµ...

     try {
        // ì•Œë¦¼ ì „ì†¡
        const response = await admin.messaging().sendEachForMulticast(message);

        // ì‘ë‹µë°›ì€ ë°ì´í„°ë¡œ ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ë°°ì—´ ìƒì„±
        const invalidTokens = tokens.filter((_, index) => {
          const errorCode = response.responses[index].error?.code;
          return errorCode === 'messaging/registration-token-not-registered';
        });

        if (invalidTokens.length > 0) {
          const deletePromises = invalidTokens.map(async (invalidToken) => {
            // Firestoreì—ì„œ í† í°ì´ í¬í•¨ëœ ë¬¸ì„œ ì°¾ê¸°
            const snapshot = await db
              .collection('FCMNotification')
              .where('tokens', 'array-contains', invalidToken)
              .get();

            const updatePromises = snapshot.docs.map(async (doc) => {
              const docData = doc.data();
              const updatedTokens = docData.tokens.filter(
                (token: string) => token !== invalidToken
              );
              await doc.ref.update({ tokens: updatedTokens });
            });
            await Promise.all(updatePromises);
          });
          await Promise.all(deletePromises);
        }
     }
     ```

     ì´ë ‡ê²Œ ì•Œë¦¼ì„ ë³´ë‚¼ ë•Œë§ˆë‹¤ ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì´ ë°œê²¬ëœë‹¤ë©´ ì‚­ì œê¹Œì§€ í•´ì£¼ëŠ” ë¡œì§ì„ ì‘ì„±í–ˆê³ , ë•ë¶„ì— ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì´ ìš°í›„ì£½ìˆœ ìŒ“ì¼ ê±±ì •ì€ ëœì—ˆë‹¤.

  3. ì •ê¸°ì ìœ¼ë¡œ í† í°ì„ ì—…ë°ì´íŠ¸í•œë‹¤.

     ê³µì‹ë¬¸ì„œì—ì„œëŠ” **í•œë‹¬ì— í•œë²ˆ**ì„ ì£¼ê¸°ë¡œ í† í°ì„ ì—…ë°ì´íŠ¸ í•´ì£¼ë©´ ëœë‹¤ê³  ì´ì•¼ê¸°í•œë‹¤. ì¼ë‹¨ì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì•±ì´ ì‹¤í–‰ë˜ë©´ í˜„ì¬ í† í°ê³¼ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” í† í°ì„ ë¹„êµí›„ ì—…ë°ì´íŠ¸í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì‘ì„±í–ˆë‹¤.

     ```javascript:client/src/App.tsx
     const compareTokenInDB = async () => {
       const token = await getDeviceToken();

       const isExistTokenInDB = fcmDoc?.tokens?.find(
         (fcmToken) => fcmToken === token
       );

       if (isExistTokenInDB) return;

       if (!isExistTokenInDB && userData?.uid) {
         const document = doc(dbService, FCM_NOTIFICATION, userData.uid);
         const fcmData = {
           createdAt: Date.now(),
           tokens:
             fcmDoc?.tokens?.length !== 0 ? [...fcmDoc?.tokens, token] : [token],
         };
         await updateDoc(document, fcmData);
       }
     };

     useEffect(() => {
       const permissionGranted =
         Notification.permission === 'granted' && fcmDoc?.notification === true

       if (permissionGranted) {
         compareTokenInDB();
       }
     }, [])
     ```

## ì•ìœ¼ë¡œ êµ¬í˜„í•´ë³¼ ê²ƒ

ì—¬ê¸°ê¹Œì§€ FCMìœ¼ë¡œ í‘¸ì‹œ ì•Œë¦¼ì„ ì–´ë–»ê²Œ êµ¬í˜„í–ˆëŠ”ì§€ ì‘ì„±í•´ë³´ì•˜ë‹¤. êµ¬í˜„í•˜ëŠ” ê³¼ì •ì—ì„œ ì •ë§ ê³µì‹ë¬¸ì„œ ì „ì²´ë¥¼ ë‹¤íšŒë…í–ˆê³ , ì—¬ëŸ¬ ë¬¸ì„œ, ì˜ìƒë“¤ì„ ë§ì´ ë´¤ë˜ ê²ƒ ê°™ë‹¤. ê³µë¶€í•œ ê²ƒë“¤ì„ ì ìš©í•´ë³´ë©´ì„œ ë§ì€ ì—ëŸ¬ë“¤ì„ ê³ ì³ë‚˜ê°”ê³ , ë˜ ì–´ë–¤ ë¡œì§ìœ¼ë¡œ ì¢€ë” ì‹ ë¢°ì„±ì´ ë†’ì€ ì½”ë“œë¥¼ ì§œì•¼í• ì§€ ë§ì€ ê³ ë¯¼ì„ í–ˆë‹¤. ì´ë ‡ê²Œ ê·¸ë™ì•ˆ ê°œë°œí–ˆë˜ ê³¼ì •ë“¤ì„ ë³µê¸°í•˜ë©° ë‹¤ì‹œ ì •ë¦¬í•˜ë‹ˆ ì¢€ë” ì´í•´ê°€ ì˜ ëœ ëŠë‚Œì´ë‹¤!ğŸ˜ƒ ê¸€ì€ ë„ˆë¬´ ê¸¸ì§€ë§Œ...ğŸ˜…

í•˜ì§€ë§Œ ì´ê²ƒì´ ëì´ ì•„ë‹ˆë¼ ë” ê°œë°œí•´ì•¼í•  ê²ƒë“¤ì´ ìˆë‹¤. í˜„ì¬ ì—¬ê¸°ê¹Œì§€ êµ¬í˜„í•˜ê³  ë°°í¬í–ˆëŠ”ë°, ë‹¤ìŒì—ëŠ” **ìŠ¤ì¼€ì¥´ í•¨ìˆ˜**ë¥¼ í•œë²ˆ ì ìš©í•´ë³´ê³  ì‹¶ë‹¤. í˜„ì¬ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•´ì•¼ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ë°, íŠ¹ì • ìš”ì¼ì— ì•Œì•„ì„œ ë°œì†¡ë˜ì–´ì•¼ í•˜ëŠ” ì•Œë¦¼ë„ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ íˆ¬í‘œí•˜ê¸°ì—ì„œ íˆ¬í‘œ ì¢…ë£Œì¼ ë‹¤ìŒë‚ ì— íˆ¬í‘œ ê²°ê³¼ë¥¼ ìœ ì €ë“¤ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤. ê·¸ëŸ° ê²½ìš°ì—ëŠ” Firebase Functions ì˜ˆì•½ í•¨ìˆ˜ì¸ `onSchedule` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ê³  Google Cloud PlatFormì„ ì„¤ì •í•˜ë©´ ë˜ëŠ” ê²ƒ ê°™ë‹¤. ì´ ë¶€ë¶„ë„ êµ¬í˜„í•˜ê³  ë‚˜ë©´ í¬ìŠ¤íŠ¸ë¡œ ì‘ì„±í•´ë³´ë ¤ê³  í•œë‹¤!

## í›„ê¸°

ë…ì„œëª¨ì„ ë©¤ë²„ë“¤ì´ ì›í–ˆë˜ ê¸°ëŠ¥ì¸ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì™„ì„±í•´ì„œ ì•„ì£¼ ë¿Œë“¯í–ˆë‹¤. ë˜ í•œí¸ìœ¼ë¡œëŠ” ì›¹ì˜ ë¬´ê¶ë¬´ì§„í•œ ë°œì „ ê°€ëŠ¥ì„±ì„ ì§ì ‘ ëª©ë„í•œ ìˆœê°„ì´ì—ˆë˜ ê²ƒ ê°™ë‹¤. ì›¹ì„ ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œ ì•±ìœ¼ë¡œ ì„¤ì¹˜í•´ ì‹¤ì œ ì•±ì²˜ëŸ¼ ë³´ì´ê³  í‘¸ì‹œ ì•Œë¦¼ê¹Œì§€ ë°›ì„ ìˆ˜ ìˆëŠ” ê²ƒì„ ë³´ë‹¤ë³´ë‹ˆ ì •ë§ ì‹ ê¸°í•˜ê³  ë˜ ì•ìœ¼ë¡œ ì›¹ì˜ ë¯¸ë˜ëŠ” ë˜ ì–´ë–»ê²Œ ë ê¹Œ ê¸°ëŒ€ê°€ ë˜ê¸°ë„ í–ˆë‹¤. ì›¹ì•±ì—ì„œ í‘¸ì‹œ ì•Œë¦¼ì„ êµ¬í˜„í•˜ë ¤ê³  í•˜ëŠ” ë¶„ë“¤ì—ê²Œ ë„ì›€ì´ ë˜ëŠ” ê¸€ì´ì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤.

## ì°¸ê³ 

[Firebase-JS-SDK Issue](https://github.com/firebase/firebase-js-sdk/issues/5403)  
[ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ ES ëª¨ë“ˆ](https://web.dev/articles/es-modules-in-sw?hl=ko)  
[ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ êµ¬í˜„í•˜ê¸°](https://blog.pium.life/web-push/)  
[FCM ì‹œì‘í•˜ê¸°](https://firebase.google.com/docs/cloud-messaging?hl=ko&_gl=1*1c2cm9z*_up*MQ..*_ga*MjEzNzM3Nzc1NC4xNzE4NTM1ODA4*_ga_CW55HF8NVT*MTcxODUzNTgwOC4xLjAuMTcxODUzNTgwOC4wLjAuMA..)  
[Firebase Functions ì‹œì‘í•˜ê¸°](https://firebase.google.com/docs/functions/get-started?hl=ko&_gl=1*1wn2txp*_up*MQ..*_ga*MTk4NjU3MzY4NC4xNzE4MDAzMDE3*_ga_CW55HF8NVT*MTcxODAwMzAxNi4xLjAuMTcxODAwMzAxNi4wLjAuMA..&gen=2nd)  
[FCM ì„œë²„ ì˜µì…˜ ì„ íƒ](https://firebase.google.com/docs/cloud-messaging/server?hl=ko&_gl=1*dim01k*_up*MQ..*_ga*MTIwMTg1MTgwMS4xNzE4MzYyMjcw*_ga_CW55HF8NVT*MTcxODM2MjI2OS4xLjAuMTcxODM2MjI2OS4wLjAuMA..#choosing-a-server-option)
[FCM ë“±ë¡ í† í° ê´€ë¦¬ë¥¼ ìœ„í•œ ê¶Œì¥ì‚¬í•­](https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ko)  
[Firebase Blog: fcm for safari ](https://firebase.blog/posts/2023/08/fcm-for-safari/)  
[[FrontEnd] FCMì„ ì´ìš©í•´ ì›¹ í‘¸ì‹œ ì•Œë¦¼ ì ìš©í•˜ê¸°](https://medium.com/@tellingme/frontend-fcm%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%9B%B9-%ED%91%B8%EC%8B%9C-%EC%95%8C%EB%A6%BC-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0-368d90974b7)  
[ì›¹ í‘¸ì‹œì•Œë¦¼ ì ìš©í•˜ê¸°(with.FCM)](https://velog.io/@sang-mini/%EC%9B%B9-%ED%91%B8%EC%8B%9C%EC%95%8C%EB%A6%BC-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0with.FCM)
